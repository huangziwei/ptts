#!/usr/bin/env bash
set -euo pipefail

image="ghcr.io/astral-sh/uv:python3.12-bookworm-slim"
rm_flag=""
if [ "${PMX_RM:-0}" = "1" ] || [ "${PMX_KEEP:-}" = "0" ]; then
  rm_flag="--rm"
fi
if [ -n "${PMX_OPTS:-}" ]; then
  # shellcheck disable=SC2086
  exec podman run $rm_flag -it \
    -v "$PWD":/work -w /work \
    -e HF_HOME=/work/.cache/huggingface \
    -e UV_CACHE_DIR=/work/.uv-cache \
    $PMX_OPTS \
    "$image" \
    "$@"
fi

exec podman run $rm_flag -it \
  -v "$PWD":/work -w /work \
  -e HF_HOME=/work/.cache/huggingface \
  -e UV_CACHE_DIR=/work/.uv-cache \
  "$image" \
  "$@"
